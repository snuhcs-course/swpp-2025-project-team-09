name: Django Backend Test Automation (CI)

on:
  push:
    # 'deployment' ë¸Œëœì¹˜ì— ì½”ë“œê°€ í‘¸ì‹œë  ë•Œ íŠ¸ë¦¬ê±°
    branches:
      - '**' 
    # backend í´ë”ì˜ ë‚´ìš©ì´ ë³€ê²½ë˜ì—ˆì„ ë•Œë§Œ ì‹¤í–‰ (íš¨ìœ¨ì„±)
    paths:
      - 'backend/**' 

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Python Environment
      uses: actions/setup-python@v4
      with:
        python-version: '3.11' # Conda í™˜ê²½ê³¼ ë™ì¼í•œ Python ë²„ì „ì„ ê¶Œì¥í•©ë‹ˆë‹¤.

    - name: Cache Python Dependencies
      uses: actions/cache@v4
      with:
        path: ${{ github.workspace }}/.venv-ci
        key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install Dependencies
      run: |
        # CI ì „ìš© ê°€ìƒ í™˜ê²½ ìƒì„± (ìºì‹œê°€ ì—†ëŠ” ê²½ìš°)
        python -m venv ${{ github.workspace }}/.venv-ci
        source ${{ github.workspace }}/.venv-ci/bin/activate
        
        # requirements.txt ë° pytest-django ì„¤ì¹˜
        pip install -r backend/requirements.txt
        pip install pytest pytest-django

    - name: Run Pytest and Discover All Tests
      # í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ê¸° ìœ„í•´ backend í´ë”ë¡œ ì´ë™í•©ë‹ˆë‹¤.
      working-directory: ./backend
      env:
        # ğŸš¨ Django settings ëª¨ë“ˆì„ ì§€ì •
        DJANGO_SETTINGS_MODULE: app.settings 
        # ğŸš¨ PYTHONPATH ì„¤ì • ê°•í™”: ë¦¬í¬ì§€í† ë¦¬ ë£¨íŠ¸ì˜ backend í´ë”ë¥¼ PYTHONPATHì— ì¶”ê°€
        # ì´ì œ 'apis' ëª¨ë“ˆì„ ìµœìƒìœ„ì—ì„œ ì°¾ì„ ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.
        PYTHONPATH: ${{ github.workspace }}/backend
      run: |
        # ğŸš¨ğŸš¨ğŸš¨ PYTHONPATHì™€ DJANGO_SETTINGS_MODULEì„ ì…¸ì—ì„œ ì§ì ‘ export ğŸš¨ğŸš¨ğŸš¨
        # env: ë¸”ë¡ì´ ì•„ë‹Œ ì…¸ì—ì„œ ê°•ì œ ì„¤ì •í•˜ì—¬ ì˜¤ë¥˜ë¥¼ ë°©ì§€í•©ë‹ˆë‹¤.
        export DJANGO_SETTINGS_MODULE=app.settings
        export PYTHONPATH=${{ github.workspace }}/backend
        
        source ${{ github.workspace }}/.venv-ci/bin/activate
        
        # ğŸš¨ ëª¨ë“  í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (user_controller_test.py í¬í•¨)
        # ì¶”í›„ í…ŒìŠ¤íŠ¸ íŒŒì¼ì´ ëŠ˜ì–´ë‚˜ë„ ì´ ëª…ë ¹ í•˜ë‚˜ë¡œ ëª¨ë‘ ì»¤ë²„ë©ë‹ˆë‹¤.
        pytest tests/
