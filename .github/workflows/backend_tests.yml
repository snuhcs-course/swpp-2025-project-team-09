name: Django Backend Test Automation (CI)

on:
  push:
    # 'deployment' ë¸Œëœì¹˜ì— ì½”ë“œê°€ í‘¸ì‹œë  ë•Œ íŠ¸ë¦¬ê±°
    branches:
      - '**' 
    # backend í´ë”ì˜ ë‚´ìš©ì´ ë³€ê²½ë˜ì—ˆì„ ë•Œë§Œ ì‹¤í–‰ (íš¨ìœ¨ì„±)
    paths:
      - 'backend/**' 

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Python Environment
      uses: actions/setup-python@v4
      with:
        python-version: '3.11' # Conda í™˜ê²½ê³¼ ë™ì¼í•œ Python ë²„ì „ì„ ê¶Œì¥í•©ë‹ˆë‹¤.

    - name: Cache Python Dependencies
      uses: actions/cache@v4
      with:
        path: ${{ github.workspace }}/.venv-ci
        key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install Dependencies
      run: |
        # CI ì „ìš© ê°€ìƒ í™˜ê²½ ìƒì„± (ìºì‹œê°€ ì—†ëŠ” ê²½ìš°)
        python -m venv ${{ github.workspace }}/.venv-ci
        source ${{ github.workspace }}/.venv-ci/bin/activate
        
        # requirements.txt ë° pytest-django ì„¤ì¹˜
        pip install -r backend/requirements.txt
        pip install pytest pytest-django

    - name: Run Pytest and Discover All Tests
      # í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ê¸° ìœ„í•´ backend í´ë”ë¡œ ì´ë™í•©ë‹ˆë‹¤.
      working-directory: ./backend
      env:
        # Django settings ëª¨ë“ˆì„ ì§€ì •
        DJANGO_SETTINGS_MODULE: app.settings 
        # PYTHONPATH ì„¤ì • ê°•í™”: ë¦¬í¬ì§€í† ë¦¬ ë£¨íŠ¸ì˜ backend í´ë”ë¥¼ PYTHONPATHì— ì¶”ê°€
        PYTHONPATH: ${{ github.workspace }}/backend
      run: |
        # 1. DJANGO_SETTINGS_MODULEì„ ë¨¼ì € ì„¤ì • (env: ë¸”ë¡ì˜ ë³€ìˆ˜ë¥¼ ì…¸ë¡œ ë‚´ë³´ëƒ„)
        export DJANGO_SETTINGS_MODULE=app.settings
        
        # 2. venv í™œì„±í™” (ì´ë•Œ PYTHONPATHê°€ ì´ˆê¸°í™”ë  ìˆ˜ ìˆìŒ)
        source ${{ github.workspace }}/.venv-ci/bin/activate

        # ğŸš¨ğŸš¨ğŸš¨ 3. PYTHONPATHë¥¼ source ëª…ë ¹ ì´í›„ì— ì¬ì„¤ì •í•˜ì—¬ ê°•ì œ ì ìš© (í•´ê²°ì±…) ğŸš¨ğŸš¨ğŸš¨
        export PYTHONPATH=${{ github.workspace }}/backend
        
        # ğŸš¨ ëª¨ë“  í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (user_controller_test.py í¬í•¨)
        # ì¶”í›„ í…ŒìŠ¤íŠ¸ íŒŒì¼ì´ ëŠ˜ì–´ë‚˜ë„ ì´ ëª…ë ¹ í•˜ë‚˜ë¡œ ëª¨ë‘ ì»¤ë²„ë©ë‹ˆë‹¤.
        pytest tests/

  # ğŸš¨ ìƒˆë¡œ ì¶”ê°€ëœ ë¦°íŠ¸ Job
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install Black
        # Flake8ì„ ì„¤ì¹˜í•˜ì—¬ ì½”ë“œë¥¼ ê²€ì‚¬í•©ë‹ˆë‹¤.
        run: pip install black
      - name: Run Black Lint Check
        working-directory: ./backend
        run: black --check . # backend í´ë” ì „ì²´ì— ëŒ€í•´ ë¦°íŠ¸ ê²€ì‚¬ ì‹¤í–‰